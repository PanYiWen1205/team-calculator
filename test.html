<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模塊載入測試</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .test-box {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔍 模塊載入測試</h1>
    
    <div class="test-box">
        <h3>📋 載入狀態檢查</h3>
        <div id="loadStatus">檢查中...</div>
    </div>
    
    <div class="test-box">
        <h3>🧪 基礎功能測試</h3>
        <div id="testResults">準備測試...</div>
    </div>
    
    <div class="test-box">
        <h3>📊 詳細除錯資訊</h3>
        <pre id="debugInfo"></pre>
    </div>

    <div class="test-box">
        <h3>🔧 建議修復方案</h3>
        <div id="suggestions"></div>
    </div>

    <!-- 載入您的模塊 -->
    <script src="js/data/cardDatabase.js"></script>
    <script src="js/calculators/baseStatsCalculator.js"></script>
    <script src="js/calculators/bonusCalculator.js"></script>
    <script src="js/utils/cardFilters.js"></script>
    <script src="js/utils/partnerProfessionUtils.js"></script>
    <script src="js/systems/coreSystem.js"></script>
    <script src="js/calculators/teamCalculator.js"></script>
    <script src="js/main.js"></script>

    <script>
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateDebugDisplay();
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        function updateDebugDisplay() {
            document.getElementById('debugInfo').textContent = debugLog.join('\n');
        }
        
        function checkModuleStatus() {
            const status = {
                cardDatabase: {
                    exists: !!window.CardDatabase,
                    instance: !!window.cardDatabase,
                    functional: !!(window.cardDatabase && window.cardDatabase.getAllPartners)
                },
                baseStatsCalculator: {
                    exists: !!window.BaseStatsCalculator,
                    instance: !!window.baseStatsCalculator,
                    functional: !!(window.baseStatsCalculator && window.baseStatsCalculator.calculateBaseStats)
                },
                bonusCalculator: {
                    exists: !!window.BonusCalculator,
                    instance: !!window.bonusCalculator,
                    functional: !!(window.bonusCalculator && window.bonusCalculator.calculateAllBonuses)
                },
                teamCalculator: {
                    exists: !!window.TeamCalculator,
                    instance: !!window.teamCalculator,
                    functional: !!(window.teamCalculator && window.teamCalculator.calculateSingleCardStats)
                },
                calc: {
                    exists: !!window.calc,
                    functional: !!(window.calc && window.calc.getAllPartners)
                }
            };
            
            return status;
        }
        
        function runTests() {
            log('開始模塊載入測試', 'info');
            
            const status = checkModuleStatus();
            let loadStatusHtml = '<h4>模塊載入狀態:</h4><ul>';
            let allLoaded = true;
            
            Object.entries(status).forEach(([moduleName, moduleStatus]) => {
                const isOk = moduleStatus.functional;
                allLoaded = allLoaded && isOk;
                
                loadStatusHtml += `<li class="${isOk ? 'success' : 'error'}">
                    ${moduleName}: 
                    存在=${moduleStatus.exists}, 
                    實例=${moduleStatus.instance}, 
                    功能=${moduleStatus.functional}
                    ${isOk ? ' ✅' : ' ❌'}
                </li>`;
                
                log(`${moduleName} - 存在:${moduleStatus.exists}, 實例:${moduleStatus.instance}, 功能:${moduleStatus.functional}`, isOk ? 'success' : 'error');
            });
            
            loadStatusHtml += '</ul>';
            document.getElementById('loadStatus').innerHTML = loadStatusHtml;
            
            // 執行功能測試
            let testResultsHtml = '<h4>功能測試結果:</h4><ul>';
            
            if (allLoaded && window.calc) {
                try {
                    // 測試1: 獲取搭檔數據
                    const partners = window.calc.getAllPartners();
                    testResultsHtml += `<li class="success">搭檔數據載入: ${partners.length} 個搭檔 ✅</li>`;
                    log(`成功載入 ${partners.length} 個搭檔`, 'success');
                    
                    // 測試2: 獲取卡片數據
                    if (partners.length > 0) {
                        const cards = window.calc.getCards(partners[0].id);
                        testResultsHtml += `<li class="success">卡片數據載入: ${cards.length} 張卡片 ✅</li>`;
                        log(`成功載入 ${cards.length} 張卡片`, 'success');
                        
                        // 測試3: 單卡計算
                        if (cards.length > 0) {
                            const cardStats = window.calc.calculateCard(cards[0].name, { level: 80, advancement: 3 });
                            testResultsHtml += `<li class="success">單卡計算: 攻擊力 ${cardStats.atk} ✅</li>`;
                            log(`單卡計算成功: ${cards[0].name} 攻擊力 ${cardStats.atk}`, 'success');
                        }
                    }
                    
                } catch (error) {
                    testResultsHtml += `<li class="error">功能測試失敗: ${error.message} ❌</li>`;
                    log(`功能測試失敗: ${error.message}`, 'error');
                }
            } else {
                testResultsHtml += `<li class="error">模塊未完全載入，無法執行功能測試 ❌</li>`;
                log('模塊未完全載入，跳過功能測試', 'warning');
            }
            
            testResultsHtml += '</ul>';
            document.getElementById('testResults').innerHTML = testResultsHtml;
            
            // 生成修復建議
            generateSuggestions(status, allLoaded);
        }
        
        function generateSuggestions(status, allLoaded) {
            let suggestionsHtml = '';
            
            if (allLoaded) {
                suggestionsHtml = `
                    <div class="success">
                        <h4>🎉 所有模塊載入成功！</h4>
                        <p>您的計算器系統工作正常，可以開始使用完整的戰鬥計算器了。</p>
                        <p><strong>建議：</strong></p>
                        <ul>
                            <li>使用您現有的計算器系統，不需要重寫</li>
                            <li>專注於改善戰鬥計算器的界面和用戶體驗</li>
                            <li>添加您需要的特定功能</li>
                        </ul>
                    </div>
                `;
            } else {
                suggestionsHtml = `
                    <div class="error">
                        <h4>❌ 模塊載入問題</h4>
                        <p><strong>可能的原因：</strong></p>
                        <ul>
                `;
                
                if (!status.cardDatabase.functional) {
                    suggestionsHtml += `<li>cardDatabase.js 載入失敗 - 檢查檔案路徑是否正確</li>`;
                }
                if (!status.calc.functional) {
                    suggestionsHtml += `<li>main.js 初始化失敗 - 檢查所有依賴是否正確載入</li>`;
                }
                
                suggestionsHtml += `
                        </ul>
                        <p><strong>修復步驟：</strong></p>
                        <ol>
                            <li>確認所有 JS 檔案都存在於正確路徑</li>
                            <li>檢查瀏覽器控制台是否有 404 錯誤</li>
                            <li>確認檔案沒有語法錯誤</li>
                            <li>嘗試在本地服務器運行（如 Live Server）</li>
                        </ol>
                    </div>
                `;
            }
            
            document.getElementById('suggestions').innerHTML = suggestionsHtml;
        }
        
        // 延遲執行測試，給模塊載入時間
        setTimeout(() => {
            runTests();
        }, 1000);
        
        // 每3秒重新檢查一次
        setInterval(() => {
            const currentStatus = checkModuleStatus();
            const calcReady = currentStatus.calc.functional;
            
            if (calcReady && !window.testCompleted) {
                window.testCompleted = true;
                log('系統已就緒！', 'success');
                runTests();
            }
        }, 3000);
    </script>
</body>
</html>
