<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ°é¬¥å‚·å®³è¨ˆç®—å™¨ - ç›´æ¥æ¨¡å¡Šç‰ˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <!-- æ¨™é¡Œ -->
            <div class="card-gradient rounded-lg p-6 mb-6 text-white text-center">
                <h1 class="text-3xl font-bold mb-2">âš”ï¸ æˆ°é¬¥å‚·å®³è¨ˆç®—å™¨</h1>
                <p class="opacity-80">ç›´æ¥ä½¿ç”¨æ‚¨çš„è¨ˆç®—å™¨æ¨¡å¡Š</p>
                <div id="systemStatus" class="text-xs mt-2 opacity-60">æª¢æŸ¥ç³»çµ±ç‹€æ…‹...</div>
            </div>

            <!-- é…ç½®é¢æ¿ -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 mb-6">
                <!-- æ­æª”é¸æ“‡ -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ‘¥ æ­æª”é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-2">æ­æª”</label>
                            <select id="partnerSelect" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                                <option value="" class="text-gray-800">é¸æ“‡æ­æª”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-2">è·æ¥­</label>
                            <select id="professionSelect" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                                <option value="" class="text-gray-800">é¸æ“‡è·æ¥­</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ç­‰ç´šé…ç½® -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">âš™ï¸ ç­‰ç´šé…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-2">ç‰½çµ†ç­‰ç´š: <span id="bondValue" class="font-bold">25</span></label>
                            <input type="range" id="bondSlider" min="1" max="220" value="25" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm mb-2">æ˜Ÿè­œåŒ¹é…: <span id="constValue" class="font-bold">0</span></label>
                            <input type="range" id="constSlider" min="0" max="6" value="0" class="w-full">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="perfectAlignment" class="text-blue-500">
                            <label for="perfectAlignment" class="text-sm">å®Œç¾æ’åˆ—</label>
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡é…ç½® -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸƒ å¡ç‰‡é…ç½®</h3>
                    <div class="space-y-3">
                        <button id="quickSetup" class="w-full py-2 px-4 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-all text-sm">
                            ğŸš€ ä¸€éµæ»¿é…
                        </button>
                        <div class="text-xs opacity-80">
                            é¸ä¸­çš„å¡ç‰‡: <span id="selectedCount">0</span>
                        </div>
                        <div id="cardList" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- å¡ç‰‡åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ¯ å¿«é€Ÿæ“ä½œ</h3>
                    <div class="space-y-3">
                        <button id="selectAllSun" class="w-full py-2 px-3 bg-yellow-500 bg-opacity-30 rounded text-sm hover:bg-opacity-50">
                            â˜€ï¸ å…¨é¸æ—¥å¡
                        </button>
                        <button id="selectAllMoon" class="w-full py-2 px-3 bg-blue-500 bg-opacity-30 rounded text-sm hover:bg-opacity-50">
                            ğŸŒ™ å…¨é¸æœˆå¡
                        </button>
                        <button id="clearSelection" class="w-full py-2 px-3 bg-red-500 bg-opacity-30 rounded text-sm hover:bg-opacity-50">
                            ğŸ—‘ï¸ æ¸…ç©ºé¸æ“‡
                        </button>
                        <button id="testCalculation" class="w-full py-2 px-3 bg-green-500 bg-opacity-30 rounded text-sm hover:bg-opacity-50">
                            ğŸ§ª æ¸¬è©¦è¨ˆç®—
                        </button>
                    </div>
                </div>
            </div>

            <!-- çµæœé¡¯ç¤º -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å±¬æ€§é¢æ¿ -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ“Š éšŠä¼å±¬æ€§</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold" id="hpDisplay">0</div>
                            <div class="text-xs opacity-80">â¤ï¸ ç”Ÿå‘½</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold" id="atkDisplay">0</div>
                            <div class="text-xs opacity-80">âš”ï¸ æ”»æ“Š</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold" id="defDisplay">0</div>
                            <div class="text-xs opacity-80">ğŸ›¡ï¸ é˜²ç¦¦</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold" id="critRateDisplay">0%</div>
                            <div class="text-xs opacity-80">âš¡ æš´æ“Šç‡</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold" id="critDmgDisplay">0%</div>
                            <div class="text-xs opacity-80">ğŸ’¥ æš´æ“Šå‚·å®³</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold" id="weaknessDisplay">0%</div>
                            <div class="text-xs opacity-80">ğŸ¯ è™›å¼±å¢å‚·</div>
                        </div>
                    </div>
                </div>

                <!-- å‚·å®³é¢æ¿ -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ’¥ æŠ€èƒ½å‚·å®³</h3>
                    <div class="space-y-3">
                        <div class="bg-white bg-opacity-10 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">ğŸ‘Š æ™®æ”»</span>
                                <div class="text-right">
                                    <div class="text-sm">ä¸€èˆ¬: <span id="basicNormal">0</span></div>
                                    <div class="text-sm text-yellow-300">æš´æ“Š: <span id="basicCrit">0</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">âš¡ ä¸»å‹•æŠ€</span>
                                <div class="text-right">
                                    <div class="text-sm">ä¸€èˆ¬: <span id="skill1Normal">0</span></div>
                                    <div class="text-sm text-yellow-300">æš´æ“Š: <span id="skill1Crit">0</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">ğŸŒŸ å…±é³´æŠ€</span>
                                <div class="text-right">
                                    <div class="text-sm">ä¸€èˆ¬: <span id="skill2Normal">0</span></div>
                                    <div class="text-sm text-yellow-300">æš´æ“Š: <span id="skill2Crit">0</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">ğŸ’« èª“ç´„æŠ€</span>
                                <div class="text-right">
                                    <div class="text-sm">ä¸€èˆ¬: <span id="ultimateNormal">0</span></div>
                                    <div class="text-sm text-yellow-300">æš´æ“Š: <span id="ultimateCrit">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç‹€æ…‹ä¿¡æ¯ -->
            <div class="card-gradient rounded-lg p-4 mt-6 text-white text-center">
                <p id="statusInfo" class="text-sm opacity-80">ç³»çµ±æª¢æŸ¥ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥æ‚¨çš„æ¨¡å¡Š -->
    <script src="js/data/cardDatabase.js"></script>
    <script src="js/calculators/baseStatsCalculator.js"></script>
    <script src="js/calculators/bonusCalculator.js"></script>
    <script src="js/utils/cardFilters.js"></script>
    <script src="js/utils/partnerProfessionUtils.js"></script>
    <script src="js/systems/coreSystem.js"></script>
    <script src="js/calculators/teamCalculator.js"></script>

    <script>
        // æŠ€èƒ½å€ç‡æ•¸æ“š
        const skillMultipliers = {
            'eternal_prophet': { basic: 0.8, skill1: 2.2, skill2: 3.8, ultimate: 5.5 },
            'jiuli_commander': { basic: 1.0, skill1: 2.5, skill2: 4.2, ultimate: 6.0 },
            'endless_raider': { basic: 0.9, skill1: 2.3, skill2: 4.0, ultimate: 5.8 },
            'abyss_master': { basic: 0.7, skill1: 2.0, skill2: 3.5, ultimate: 5.2 },
            'light_chaser': { basic: 1.1, skill1: 2.4, skill2: 4.1, ultimate: 6.2 },
            'light_hunter': { basic: 0.8, skill1: 2.1, skill2: 3.7, ultimate: 5.4 },
            'fleet_officer': { basic: 0.9, skill1: 2.2, skill2: 3.9, ultimate: 5.6 },
            'weapon_x02': { basic: 1.0, skill1: 2.6, skill2: 4.3, ultimate: 6.1 },
            'deep_sea_diver': { basic: 0.95, skill1: 2.4, skill2: 4.0, ultimate: 5.9 },
            'tidal_god': { basic: 0.85, skill1: 2.1, skill2: 3.6, ultimate: 5.3 }
        };

        // æ‡‰ç”¨ç‹€æ…‹
        let appState = {
            ready: false,
            selectedPartner: '',
            selectedProfession: '',
            selectedCards: [],
            bondLevel: 25,
            constellationLevel: 0,
            perfectAlignment: false,
            // ç›´æ¥å¼•ç”¨å·²è¼‰å…¥çš„æ¨¡å¡Š
            cardDatabase: null,
            baseStatsCalculator: null,
            bonusCalculator: null,
            teamCalculator: null,
            cardFilters: null
        };

        // åˆå§‹åŒ–è‡ªå®šç¾©è¨ˆç®—å™¨
        function initializeCustomCalculator() {
            // æª¢æŸ¥æ¨¡å¡Šæ˜¯å¦è¼‰å…¥
            if (!window.cardDatabase || !window.baseStatsCalculator || !window.bonusCalculator || !window.teamCalculator) {
                console.error('å¿…è¦æ¨¡å¡Šæœªè¼‰å…¥');
                return false;
            }

            // è¨­ç½®ä¾è³´æ³¨å…¥
            if (window.teamCalculator.setDependencies) {
                const dependencies = {
                    baseStatsCalculator: window.baseStatsCalculator,
                    bonusCalculator: window.bonusCalculator,
                    cardDatabase: window.cardDatabase,
                    cardFilters: window.cardFilters || null
                };
                
                window.teamCalculator.setDependencies(dependencies);
                console.log('âœ… ä¾è³´æ³¨å…¥è¨­ç½®å®Œæˆ');
            }

            // ä¿å­˜æ¨¡å¡Šå¼•ç”¨
            appState.cardDatabase = window.cardDatabase;
            appState.baseStatsCalculator = window.baseStatsCalculator;
            appState.bonusCalculator = window.bonusCalculator;
            appState.teamCalculator = window.teamCalculator;
            appState.cardFilters = window.cardFilters;

            return true;
        }

        // æ›´æ–°ç³»çµ±ç‹€æ…‹é¡¯ç¤º
        function updateSystemStatus() {
            const status = {
                cardDatabase: !!window.cardDatabase,
                baseStatsCalculator: !!window.baseStatsCalculator,
                bonusCalculator: !!window.bonusCalculator,
                teamCalculator: !!window.teamCalculator
            };

            const loadedCount = Object.values(status).filter(Boolean).length;
            const totalCount = Object.keys(status).length;
            
            const statusEl = document.getElementById('systemStatus');
            if (loadedCount === totalCount) {
                statusEl.textContent = `ç³»çµ±å°±ç·’ - æ‰€æœ‰æ¨¡å¡Šå·²è¼‰å…¥ (${loadedCount}/${totalCount})`;
                statusEl.className = 'text-xs mt-2 text-green-300';
            } else {
                statusEl.textContent = `è¼‰å…¥ä¸­... (${loadedCount}/${totalCount})`;
                statusEl.className = 'text-xs mt-2 text-yellow-300';
            }

            return loadedCount === totalCount;
        }

        // ä½¿ç”¨æ‚¨çš„ç²¾ç¢ºè¨ˆç®—æ–¹æ³•
        function calculateSingleCard(cardName, config = {}) {
            if (!appState.teamCalculator) return null;

            try {
                const defaultConfig = {
                    level: 80,
                    breakthrough: 1,
                    advancement: 3,
                    userConstellationMatch: appState.constellationLevel,
                    userPerfectAlignment: appState.perfectAlignment
                };

                const card = appState.cardDatabase.getCardByName(cardName);
                if (!card) return null;

                const finalConfig = { ...defaultConfig, ...config, card };
                return appState.teamCalculator.calculateSingleCardStats(finalConfig);
            } catch (error) {
                console.error('å–®å¡è¨ˆç®—éŒ¯èª¤:', error);
                return null;
            }
        }

        // ä½¿ç”¨æ‚¨çš„ç²¾ç¢ºè¨ˆç®—æ–¹æ³•è¨ˆç®—éšŠä¼
        function calculateTeam() {
            if (!appState.teamCalculator || appState.selectedCards.length === 0) {
                return null;
            }

            try {
                const teamConfig = {
                    cards: appState.selectedCards,
                    levels: new Array(appState.selectedCards.length).fill(80),
                    breakthroughs: new Array(appState.selectedCards.length).fill(1),
                    advancements: new Array(appState.selectedCards.length).fill(3),
                    partnerBondLevel: appState.bondLevel,
                    userConstellationMatch: appState.constellationLevel,
                    userPerfectAlignment: appState.perfectAlignment
                };

                return appState.teamCalculator.calculateTeamStats(teamConfig);
            } catch (error) {
                console.error('éšŠä¼è¨ˆç®—éŒ¯èª¤:', error);
                return null;
            }
        }

        // è¨ˆç®—ç‰½çµ†åŠ æˆ
        function calculateBondBonus(bondLevel) {
            if (!appState.bonusCalculator) {
                // å‚™æ´è¨ˆç®—
                if (bondLevel < 5) return { hp: 0, atk: 0, def: 0 };
                const bonusCount = Math.floor((bondLevel - 5) / 5) + 1;
                return { hp: bonusCount * 200, atk: bonusCount * 10, def: bonusCount * 5 };
            }

            return appState.bonusCalculator.calculatePartnerBondBonus(bondLevel);
        }

        // åˆå§‹åŒ–ç•Œé¢
        function initializeUI() {
            if (!appState.cardDatabase) return;

            // è¼‰å…¥æ­æª”é¸é …
            const partnerSelect = document.getElementById('partnerSelect');
            const partners = appState.cardDatabase.getAllPartners();
            
            partners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                option.textContent = partner.name;
                option.className = 'text-gray-800';
                partnerSelect.appendChild(option);
            });

            // ç¶å®šäº‹ä»¶
            bindEvents();
            updateStatus('ç•Œé¢åˆå§‹åŒ–å®Œæˆ');
        }

        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('partnerSelect').addEventListener('change', handlePartnerChange);
            document.getElementById('professionSelect').addEventListener('change', handleProfessionChange);
            document.getElementById('bondSlider').addEventListener('input', handleBondChange);
            document.getElementById('constSlider').addEventListener('input', handleConstChange);
            document.getElementById('perfectAlignment').addEventListener('change', handlePerfectAlignmentChange);
            
            document.getElementById('quickSetup').addEventListener('click', quickSetup);
            document.getElementById('selectAllSun').addEventListener('click', () => selectCardsByCategory('æ—¥å¡'));
            document.getElementById('selectAllMoon').addEventListener('click', () => selectCardsByCategory('æœˆå¡'));
            document.getElementById('clearSelection').addEventListener('click', clearCardSelection);
            document.getElementById('testCalculation').addEventListener('click', testCalculation);
        }

        // äº‹ä»¶è™•ç†å‡½æ•¸
        function handlePartnerChange(e) {
            appState.selectedPartner = e.target.value;
            updateProfessions();
            updateCards();
            const partnerName = appState.cardDatabase.getAllPartners().find(p => p.id === appState.selectedPartner)?.name || '';
            updateStatus(appState.selectedPartner ? `å·²é¸æ“‡æ­æª”: ${partnerName}` : 'é¸æ“‡æ­æª”é–‹å§‹è¨ˆç®—');
        }

        function handleProfessionChange(e) {
            appState.selectedProfession = e.target.value;
            calculate();
            updateStatus(appState.selectedProfession ? 'è·æ¥­å·²é¸æ“‡ï¼Œé–‹å§‹è¨ˆç®—å‚·å®³' : 'è«‹é¸æ“‡è·æ¥­');
        }

        function handleBondChange(e) {
            appState.bondLevel = parseInt(e.target.value);
            document.getElementById('bondValue').textContent = appState.bondLevel;
            updateBondBonus();
            calculate();
        }

        function handleConstChange(e) {
            appState.constellationLevel = parseInt(e.target.value);
            document.getElementById('constValue').textContent = appState.constellationLevel;
            calculate();
        }

        function handlePerfectAlignmentChange(e) {
            appState.perfectAlignment = e.target.checked;
            calculate();
        }

        // æ›´æ–°è·æ¥­é¸é …
        function updateProfessions() {
            const professionSelect = document.getElementById('professionSelect');
            professionSelect.innerHTML = '<option value="" class="text-gray-800">é¸æ“‡è·æ¥­</option>';
            
            if (appState.selectedPartner && appState.cardDatabase) {
                const professions = appState.cardDatabase.getProfessionsByPartner(appState.selectedPartner);
                professions.forEach(profession => {
                    const option = document.createElement('option');
                    option.value = profession.id;
                    option.textContent = profession.name;
                    option.className = 'text-gray-800';
                    professionSelect.appendChild(option);
                });
            }
        }

        // æ›´æ–°å¡ç‰‡åˆ—è¡¨
        function updateCards() {
            const cardList = document.getElementById('cardList');
            cardList.innerHTML = '';
            appState.selectedCards = [];
            
            if (appState.selectedPartner && appState.cardDatabase) {
                const cards = appState.cardDatabase.getAllCards().filter(card => card.partner === appState.selectedPartner);
                
                cards.forEach((card, index) => {
                    const cardElement = document.createElement('label');
                    cardElement.className = 'flex items-center space-x-2 cursor-pointer hover:bg-white hover:bg-opacity-10 rounded p-2 text-sm';
                    cardElement.innerHTML = `
                        <input type="checkbox" class="text-blue-500" data-card-index="${index}">
                        <span class="flex-1">${card.name}</span>
                        <span class="text-xs opacity-60">${card.category}</span>
                    `;
                    
                    cardElement.querySelector('input').addEventListener('change', () => updateSelectedCards(cards));
                    cardList.appendChild(cardElement);
                });
            }
            
            updateSelectedCount();
        }

        // æ›´æ–°é¸ä¸­çš„å¡ç‰‡
        function updateSelectedCards(availableCards) {
            appState.selectedCards = [];
            const checkboxes = document.querySelectorAll('#cardList input[type="checkbox"]:checked');
            
            checkboxes.forEach(cb => {
                const cardIndex = parseInt(cb.dataset.cardIndex);
                if (availableCards[cardIndex]) {
                    appState.selectedCards.push(availableCards[cardIndex]);
                }
            });
            
            updateSelectedCount();
            calculate();
        }

        // æ›´æ–°é¸ä¸­å¡ç‰‡è¨ˆæ•¸
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = appState.selectedCards.length;
        }

        // æ›´æ–°ç‰½çµ†åŠ æˆé¡¯ç¤º
        function updateBondBonus() {
            const bonus = calculateBondBonus(appState.bondLevel);
            // é€™è£¡å¯ä»¥é¡¯ç¤ºç‰½çµ†åŠ æˆï¼Œæš«æ™‚çœç•¥UIæ›´æ–°
        }

        // å¿«é€Ÿè¨­ç½®
        function quickSetup() {
            document.getElementById('bondSlider').value = 220;
            document.getElementById('constSlider').value = 6;
            document.getElementById('perfectAlignment').checked = true;
            
            appState.bondLevel = 220;
            appState.constellationLevel = 6;
            appState.perfectAlignment = true;
            
            document.getElementById('bondValue').textContent = '220';
            document.getElementById('constValue').textContent = '6';
            
            // å…¨é¸å¡ç‰‡
            const checkboxes = document.querySelectorAll('#cardList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            
            updateSelectedCards(appState.cardDatabase.getAllCards().filter(card => card.partner === appState.selectedPartner));
        }

        // æŒ‰é¡åˆ¥é¸æ“‡å¡ç‰‡
        function selectCardsByCategory(category) {
            const checkboxes = document.querySelectorAll('#cardList input[type="checkbox"]');
            const availableCards = appState.cardDatabase.getAllCards().filter(card => card.partner === appState.selectedPartner);
            
            checkboxes.forEach(cb => {
                const cardIndex = parseInt(cb.dataset.cardIndex);
                const card = availableCards[cardIndex];
                cb.checked = card && card.category === category;
            });
            updateSelectedCards(availableCards);
        }

        // æ¸…ç©ºå¡ç‰‡é¸æ“‡
        function clearCardSelection() {
            const checkboxes = document.querySelectorAll('#cardList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            const availableCards = appState.cardDatabase.getAllCards().filter(card => card.partner === appState.selectedPartner);
            updateSelectedCards(availableCards);
        }

        // æ¸¬è©¦è¨ˆç®—åŠŸèƒ½
        function testCalculation() {
            if (!appState.cardDatabase) {
                updateStatus('âŒ cardDatabase æœªè¼‰å…¥');
                return;
            }

            try {
                // æ¸¬è©¦å–®å¡è¨ˆç®—
                const testCard = appState.cardDatabase.getCardByName('æ“é›ªè¦‹ç·£');
                if (testCard) {
                    const cardStats = calculateSingleCard('æ“é›ªè¦‹ç·£');
                    updateStatus(`âœ… æ¸¬è©¦æˆåŠŸ: æ“é›ªè¦‹ç·£ æ”»æ“ŠåŠ› ${cardStats?.atk || 'æœªçŸ¥'}`);
                } else {
                    updateStatus('âŒ æ¸¬è©¦å¡ç‰‡æœªæ‰¾åˆ°');
                }
            } catch (error) {
                updateStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        // ä¸»è¨ˆç®—å‡½æ•¸
        function calculate() {
            if (!appState.selectedPartner || !appState.selectedProfession || appState.selectedCards.length === 0) {
                resetDisplay();
                return;
            }

            const teamStats = calculateTeam();
            if (teamStats) {
                updateDisplay(teamStats);
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay(teamStats) {
            // æ›´æ–°å±¬æ€§é¡¯ç¤º
            document.getElementById('hpDisplay').textContent = teamStats.hp.toLocaleString();
            document.getElementById('atkDisplay').textContent = teamStats.atk.toLocaleString();
            document.getElementById('defDisplay').textContent = teamStats.def.toLocaleString();
            document.getElementById('critRateDisplay').textContent = teamStats.criticalRate.toFixed(1) + '%';
            document.getElementById('critDmgDisplay').textContent = teamStats.criticalDamage.toFixed(1) + '%';
            document.getElementById('weaknessDisplay').textContent = teamStats.weaknessDamage.toFixed(1) + '%';
            
            // è¨ˆç®—æŠ€èƒ½å‚·å®³
            calculateSkillDamage(teamStats);
            
            updateStatus(`âœ… è¨ˆç®—å®Œæˆ - ${appState.selectedCards.length}å¼µå¡ç‰‡ï¼Œæ”»æ“ŠåŠ›: ${teamStats.atk.toLocaleString()}`);
        }

        // è¨ˆç®—æŠ€èƒ½å‚·å®³
        function calculateSkillDamage(teamStats) {
            const multipliers = skillMultipliers[appState.selectedProfession] || 
                              { basic: 1.0, skill1: 2.5, skill2: 4.0, ultimate: 6.0 };

            const baseAtk = teamStats.atk;
            const critDamage = 100 + teamStats.criticalDamage;

            ['basic', 'skill1', 'skill2', 'ultimate'].forEach(skill => {
                const multiplier = multipliers[skill];
                const normalDmg = Math.floor(baseAtk * multiplier);
                const critDmg = Math.floor(normalDmg * (critDamage / 100));
                
                document.getElementById(`${skill}Normal`).textContent = normalDmg.toLocaleString();
                document.getElementById(`${skill}Crit`).textContent = critDmg.toLocaleString();
            });
        }

        // é‡ç½®é¡¯ç¤º
        function resetDisplay() {
            ['hpDisplay', 'atkDisplay', 'defDisplay'].forEach(id => {
                document.getElementById(id).textContent = '0';
            });
            ['critRateDisplay', 'critDmgDisplay', 'weaknessDisplay'].forEach(id => {
                document.getElementById(id).textContent = '0%';
            });
            ['basicNormal', 'basicCrit', 'skill1Normal', 'skill1Crit', 
             'skill2Normal', 'skill2Crit', 'ultimateNormal', 'ultimateCrit'].forEach(id => {
                document.getElementById(id).textContent = '0';
            });
        }

        // æ›´æ–°ç‹€æ…‹ä¿¡æ¯
        function updateStatus(message) {
            document.getElementById('statusInfo').textContent = message;
        }

        // ä¸»åˆå§‹åŒ–å‡½æ•¸
        function initializeApp() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨...');
            
            // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
            const systemReady = updateSystemStatus();
            
            if (systemReady) {
                // åˆå§‹åŒ–è‡ªå®šç¾©è¨ˆç®—å™¨
                const calcReady = initializeCustomCalculator();
                
                if (calcReady) {
                    // åˆå§‹åŒ–ç•Œé¢
                    initializeUI();
                    appState.ready = true;
                    updateStatus('âœ… ç³»çµ±å°±ç·’ - ä½¿ç”¨æ‚¨çš„ç²¾ç¢ºè¨ˆç®—å™¨');
                    console.log('âœ… æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆ');
                } else {
                    updateStatus('âŒ è¨ˆç®—å™¨åˆå§‹åŒ–å¤±æ•—');
                }
            } else {
                updateStatus('â³ ç­‰å¾…æ¨¡å¡Šè¼‰å…¥...');
                // 5ç§’å¾Œé‡è©¦
                setTimeout(initializeApp, 5000);
            }
        }

        // ç­‰å¾…DOMè¼‰å…¥å®Œæˆå¾Œå•Ÿå‹•
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOM è¼‰å…¥å®Œæˆ');
            // çµ¦æ¨¡å¡Šä¸€äº›è¼‰å…¥æ™‚é–“
            setTimeout(initializeApp, 1000);
        });

        // æ¯3ç§’æª¢æŸ¥ä¸€æ¬¡ç³»çµ±ç‹€æ…‹
        setInterval(() => {
            if (!appState.ready) {
                updateSystemStatus();
                
                // å¦‚æœæ¨¡å¡Šéƒ½è¼‰å…¥äº†ä½†æ‡‰ç”¨é‚„æ²’å°±ç·’ï¼Œå˜—è©¦åˆå§‹åŒ–
                if (window.cardDatabase && window.baseStatsCalculator && 
                    window.bonusCalculator && window.teamCalculator && !appState.ready) {
                    initializeApp();
                }
            }
        }, 3000);
    </script>
</body>
</html>
