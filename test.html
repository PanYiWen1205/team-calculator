<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å¡Šè¼‰å…¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .test-box {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ¨¡å¡Šè¼‰å…¥æ¸¬è©¦</h1>
    
    <div class="test-box">
        <h3>ğŸ“‹ è¼‰å…¥ç‹€æ…‹æª¢æŸ¥</h3>
        <div id="loadStatus">æª¢æŸ¥ä¸­...</div>
    </div>
    
    <div class="test-box">
        <h3>ğŸ§ª åŸºç¤åŠŸèƒ½æ¸¬è©¦</h3>
        <div id="testResults">æº–å‚™æ¸¬è©¦...</div>
    </div>
    
    <div class="test-box">
        <h3>ğŸ“Š è©³ç´°é™¤éŒ¯è³‡è¨Š</h3>
        <pre id="debugInfo"></pre>
    </div>

    <div class="test-box">
        <h3>ğŸ”§ å»ºè­°ä¿®å¾©æ–¹æ¡ˆ</h3>
        <div id="suggestions"></div>
    </div>

    <!-- è¼‰å…¥æ‚¨çš„æ¨¡å¡Š -->
    <script src="js/data/cardDatabase.js"></script>
    <script src="js/calculators/baseStatsCalculator.js"></script>
    <script src="js/calculators/bonusCalculator.js"></script>
    <script src="js/utils/cardFilters.js"></script>
    <script src="js/utils/partnerProfessionUtils.js"></script>
    <script src="js/systems/coreSystem.js"></script>
    <script src="js/calculators/teamCalculator.js"></script>
    <script src="js/main.js"></script>

    <script>
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateDebugDisplay();
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        function updateDebugDisplay() {
            document.getElementById('debugInfo').textContent = debugLog.join('\n');
        }
        
        function checkModuleStatus() {
            const status = {
                cardDatabase: {
                    exists: !!window.CardDatabase,
                    instance: !!window.cardDatabase,
                    functional: !!(window.cardDatabase && window.cardDatabase.getAllPartners)
                },
                baseStatsCalculator: {
                    exists: !!window.BaseStatsCalculator,
                    instance: !!window.baseStatsCalculator,
                    functional: !!(window.baseStatsCalculator && window.baseStatsCalculator.calculateBaseStats)
                },
                bonusCalculator: {
                    exists: !!window.BonusCalculator,
                    instance: !!window.bonusCalculator,
                    functional: !!(window.bonusCalculator && window.bonusCalculator.calculateAllBonuses)
                },
                teamCalculator: {
                    exists: !!window.TeamCalculator,
                    instance: !!window.teamCalculator,
                    functional: !!(window.teamCalculator && window.teamCalculator.calculateSingleCardStats)
                },
                calc: {
                    exists: !!window.calc,
                    functional: !!(window.calc && window.calc.getAllPartners)
                }
            };
            
            return status;
        }
        
        function runTests() {
            log('é–‹å§‹æ¨¡å¡Šè¼‰å…¥æ¸¬è©¦', 'info');
            
            const status = checkModuleStatus();
            let loadStatusHtml = '<h4>æ¨¡å¡Šè¼‰å…¥ç‹€æ…‹:</h4><ul>';
            let allLoaded = true;
            
            Object.entries(status).forEach(([moduleName, moduleStatus]) => {
                const isOk = moduleStatus.functional;
                allLoaded = allLoaded && isOk;
                
                loadStatusHtml += `<li class="${isOk ? 'success' : 'error'}">
                    ${moduleName}: 
                    å­˜åœ¨=${moduleStatus.exists}, 
                    å¯¦ä¾‹=${moduleStatus.instance}, 
                    åŠŸèƒ½=${moduleStatus.functional}
                    ${isOk ? ' âœ…' : ' âŒ'}
                </li>`;
                
                log(`${moduleName} - å­˜åœ¨:${moduleStatus.exists}, å¯¦ä¾‹:${moduleStatus.instance}, åŠŸèƒ½:${moduleStatus.functional}`, isOk ? 'success' : 'error');
            });
            
            loadStatusHtml += '</ul>';
            document.getElementById('loadStatus').innerHTML = loadStatusHtml;
            
            // åŸ·è¡ŒåŠŸèƒ½æ¸¬è©¦
            let testResultsHtml = '<h4>åŠŸèƒ½æ¸¬è©¦çµæœ:</h4><ul>';
            
            if (allLoaded && window.calc) {
                try {
                    // æ¸¬è©¦1: ç²å–æ­æª”æ•¸æ“š
                    const partners = window.calc.getAllPartners();
                    testResultsHtml += `<li class="success">æ­æª”æ•¸æ“šè¼‰å…¥: ${partners.length} å€‹æ­æª” âœ…</li>`;
                    log(`æˆåŠŸè¼‰å…¥ ${partners.length} å€‹æ­æª”`, 'success');
                    
                    // æ¸¬è©¦2: ç²å–å¡ç‰‡æ•¸æ“š
                    if (partners.length > 0) {
                        const cards = window.calc.getCards(partners[0].id);
                        testResultsHtml += `<li class="success">å¡ç‰‡æ•¸æ“šè¼‰å…¥: ${cards.length} å¼µå¡ç‰‡ âœ…</li>`;
                        log(`æˆåŠŸè¼‰å…¥ ${cards.length} å¼µå¡ç‰‡`, 'success');
                        
                        // æ¸¬è©¦3: å–®å¡è¨ˆç®—
                        if (cards.length > 0) {
                            const cardStats = window.calc.calculateCard(cards[0].name, { level: 80, advancement: 3 });
                            testResultsHtml += `<li class="success">å–®å¡è¨ˆç®—: æ”»æ“ŠåŠ› ${cardStats.atk} âœ…</li>`;
                            log(`å–®å¡è¨ˆç®—æˆåŠŸ: ${cards[0].name} æ”»æ“ŠåŠ› ${cardStats.atk}`, 'success');
                        }
                    }
                    
                } catch (error) {
                    testResultsHtml += `<li class="error">åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message} âŒ</li>`;
                    log(`åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                }
            } else {
                testResultsHtml += `<li class="error">æ¨¡å¡Šæœªå®Œå…¨è¼‰å…¥ï¼Œç„¡æ³•åŸ·è¡ŒåŠŸèƒ½æ¸¬è©¦ âŒ</li>`;
                log('æ¨¡å¡Šæœªå®Œå…¨è¼‰å…¥ï¼Œè·³éåŠŸèƒ½æ¸¬è©¦', 'warning');
            }
            
            testResultsHtml += '</ul>';
            document.getElementById('testResults').innerHTML = testResultsHtml;
            
            // ç”Ÿæˆä¿®å¾©å»ºè­°
            generateSuggestions(status, allLoaded);
        }
        
        function generateSuggestions(status, allLoaded) {
            let suggestionsHtml = '';
            
            if (allLoaded) {
                suggestionsHtml = `
                    <div class="success">
                        <h4>ğŸ‰ æ‰€æœ‰æ¨¡å¡Šè¼‰å…¥æˆåŠŸï¼</h4>
                        <p>æ‚¨çš„è¨ˆç®—å™¨ç³»çµ±å·¥ä½œæ­£å¸¸ï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨å®Œæ•´çš„æˆ°é¬¥è¨ˆç®—å™¨äº†ã€‚</p>
                        <p><strong>å»ºè­°ï¼š</strong></p>
                        <ul>
                            <li>ä½¿ç”¨æ‚¨ç¾æœ‰çš„è¨ˆç®—å™¨ç³»çµ±ï¼Œä¸éœ€è¦é‡å¯«</li>
                            <li>å°ˆæ³¨æ–¼æ”¹å–„æˆ°é¬¥è¨ˆç®—å™¨çš„ç•Œé¢å’Œç”¨æˆ¶é«”é©—</li>
                            <li>æ·»åŠ æ‚¨éœ€è¦çš„ç‰¹å®šåŠŸèƒ½</li>
                        </ul>
                    </div>
                `;
            } else {
                suggestionsHtml = `
                    <div class="error">
                        <h4>âŒ æ¨¡å¡Šè¼‰å…¥å•é¡Œ</h4>
                        <p><strong>å¯èƒ½çš„åŸå› ï¼š</strong></p>
                        <ul>
                `;
                
                if (!status.cardDatabase.functional) {
                    suggestionsHtml += `<li>cardDatabase.js è¼‰å…¥å¤±æ•— - æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢º</li>`;
                }
                if (!status.calc.functional) {
                    suggestionsHtml += `<li>main.js åˆå§‹åŒ–å¤±æ•— - æª¢æŸ¥æ‰€æœ‰ä¾è³´æ˜¯å¦æ­£ç¢ºè¼‰å…¥</li>`;
                }
                
                suggestionsHtml += `
                        </ul>
                        <p><strong>ä¿®å¾©æ­¥é©Ÿï¼š</strong></p>
                        <ol>
                            <li>ç¢ºèªæ‰€æœ‰ JS æª”æ¡ˆéƒ½å­˜åœ¨æ–¼æ­£ç¢ºè·¯å¾‘</li>
                            <li>æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰ 404 éŒ¯èª¤</li>
                            <li>ç¢ºèªæª”æ¡ˆæ²’æœ‰èªæ³•éŒ¯èª¤</li>
                            <li>å˜—è©¦åœ¨æœ¬åœ°æœå‹™å™¨é‹è¡Œï¼ˆå¦‚ Live Serverï¼‰</li>
                        </ol>
                    </div>
                `;
            }
            
            document.getElementById('suggestions').innerHTML = suggestionsHtml;
        }
        
        // å»¶é²åŸ·è¡Œæ¸¬è©¦ï¼Œçµ¦æ¨¡å¡Šè¼‰å…¥æ™‚é–“
        setTimeout(() => {
            runTests();
        }, 1000);
        
        // æ¯3ç§’é‡æ–°æª¢æŸ¥ä¸€æ¬¡
        setInterval(() => {
            const currentStatus = checkModuleStatus();
            const calcReady = currentStatus.calc.functional;
            
            if (calcReady && !window.testCompleted) {
                window.testCompleted = true;
                log('ç³»çµ±å·²å°±ç·’ï¼', 'success');
                runTests();
            }
        }, 3000);
    </script>
</body>
</html>
