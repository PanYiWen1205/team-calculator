<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ°é¬¥å‚·å®³è¨ˆç®—å™¨ - ç©©å¥ç‰ˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .debug-info {
            background: rgba(0,0,0,0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="card-gradient rounded-lg p-8 text-center text-white max-w-lg mx-4">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-bold mb-2">è¼‰å…¥æˆ°é¬¥è¨ˆç®—å™¨</h2>
            <p id="loadingStatus" class="text-sm opacity-80">æª¢æŸ¥ç³»çµ±ç’°å¢ƒ...</p>
            <div class="w-full bg-white bg-opacity-20 rounded-full h-2 mt-4">
                <div id="progressBar" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- é™¤éŒ¯è³‡è¨Š -->
            <div class="debug-info text-left text-xs">
                <div class="text-yellow-300 mb-2">ğŸ” è¼‰å…¥ç‹€æ…‹æª¢æŸ¥:</div>
                <div id="debugInfo"></div>
            </div>
            
            <!-- éŒ¯èª¤è³‡è¨Š -->
            <div id="errorMessage" class="mt-4 p-3 bg-red-500 bg-opacity-20 rounded text-red-200 text-sm hidden"></div>
            
            <!-- æ‰‹å‹•è¼‰å…¥æŒ‰éˆ• -->
            <button id="retryBtn" class="hidden mt-4 px-4 py-2 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-all">
                ğŸ”„ é‡è©¦è¼‰å…¥
            </button>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ -->
    <div id="app" class="hidden min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <!-- æ¨™é¡Œ -->
            <div class="card-gradient rounded-lg p-6 mb-6 text-white text-center">
                <h1 class="text-3xl font-bold mb-2">âš”ï¸ æˆ°é¬¥å‚·å®³è¨ˆç®—å™¨</h1>
                <p class="opacity-80">å®Œæ•´æ•¸æ“šåº«ç‰ˆæœ¬</p>
            </div>

            <!-- å¿«é€Ÿæ¸¬è©¦é¢æ¿ -->
            <div class="card-gradient rounded-lg p-4 mb-6 text-white">
                <h3 class="text-lg font-bold mb-3">ğŸ§ª å¿«é€Ÿæ¸¬è©¦</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="quickTest1()" class="py-2 px-4 bg-blue-500 bg-opacity-30 rounded hover:bg-opacity-50 transition-all">
                        æ¸¬è©¦å–®å¡è¨ˆç®—
                    </button>
                    <button onclick="quickTest2()" class="py-2 px-4 bg-green-500 bg-opacity-30 rounded hover:bg-opacity-50 transition-all">
                        æ¸¬è©¦éšŠä¼è¨ˆç®—
                    </button>
                    <button onclick="quickTest3()" class="py-2 px-4 bg-purple-500 bg-opacity-30 rounded hover:bg-opacity-50 transition-all">
                        æ¸¬è©¦æ•¸æ“šè¼‰å…¥
                    </button>
                </div>
                <div id="testResults" class="mt-3 p-3 bg-black bg-opacity-20 rounded text-sm font-mono min-h-16">
                    é»æ“ŠæŒ‰éˆ•é€²è¡Œæ¸¬è©¦...
                </div>
            </div>

            <!-- é…ç½®é¢æ¿ -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 mb-6">
                <!-- æ­æª”é¸æ“‡ -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ‘¥ æ­æª”é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-2">æ­æª”</label>
                            <select id="partnerSelect" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30">
                                <option value="" class="text-gray-800">é¸æ“‡æ­æª”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-2">è·æ¥­</label>
                            <select id="professionSelect" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30">
                                <option value="" class="text-gray-800">é¸æ“‡è·æ¥­</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ç­‰ç´šé…ç½® -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">âš™ï¸ ç­‰ç´šé…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-2">ç‰½çµ†ç­‰ç´š: <span id="bondValue" class="font-bold">25</span></label>
                            <input type="range" id="bondSlider" min="1" max="220" value="25" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm mb-2">æ˜Ÿè­œåŒ¹é…: <span id="constValue" class="font-bold">0</span></label>
                            <input type="range" id="constSlider" min="0" max="6" value="0" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡é…ç½® -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸƒ å¡ç‰‡é…ç½®</h3>
                    <div class="space-y-3">
                        <button id="quickSetup" class="w-full py-2 px-4 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-all text-sm">
                            ğŸš€ ä¸€éµæ»¿é…
                        </button>
                        <div class="text-xs opacity-80">
                            é¸ä¸­çš„å¡ç‰‡: <span id="selectedCount">0</span>
                        </div>
                        <div id="cardList" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- å¡ç‰‡åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>

                <!-- çµæœé è¦½ -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ“Š çµæœé è¦½</h3>
                    <div class="space-y-3">
                        <div class="bg-white bg-opacity-10 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold" id="atkDisplay">0</div>
                            <div class="text-xs opacity-80">âš”ï¸ æ”»æ“ŠåŠ›</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold" id="skillDmgDisplay">0</div>
                            <div class="text-xs opacity-80">ğŸ’¥ æŠ€èƒ½å‚·å®³</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è©³ç´°çµæœ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å±¬æ€§è©³æƒ… -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">ğŸ“‹ è©³ç´°å±¬æ€§</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>â¤ï¸ ç”Ÿå‘½: <span id="hpDetail">0</span></div>
                        <div>âš”ï¸ æ”»æ“Š: <span id="atkDetail">0</span></div>
                        <div>ğŸ›¡ï¸ é˜²ç¦¦: <span id="defDetail">0</span></div>
                        <div>âš¡ æš´æ“Šç‡: <span id="critRateDetail">0%</span></div>
                        <div>ğŸ’¥ æš´æ“Šå‚·å®³: <span id="critDmgDetail">0%</span></div>
                        <div>ğŸ¯ è™›å¼±å¢å‚·: <span id="weaknessDetail">0%</span></div>
                    </div>
                </div>

                <!-- æŠ€èƒ½å‚·å®³è©³æƒ… -->
                <div class="card-gradient rounded-lg p-6 text-white">
                    <h3 class="text-lg font-bold mb-4">âš”ï¸ æŠ€èƒ½å‚·å®³è©³æƒ…</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>ğŸ‘Š æ™®æ”»:</span>
                            <span><span id="basicNormal">0</span> / <span id="basicCrit" class="text-yellow-300">0</span></span>
                        </div>
                        <div class="flex justify-between">
                            <span>âš¡ ä¸»å‹•æŠ€:</span>
                            <span><span id="skill1Normal">0</span> / <span id="skill1Crit" class="text-yellow-300">0</span></span>
                        </div>
                        <div class="flex justify-between">
                            <span>ğŸŒŸ å…±é³´æŠ€:</span>
                            <span><span id="skill2Normal">0</span> / <span id="skill2Crit" class="text-yellow-300">0</span></span>
                        </div>
                        <div class="flex justify-between">
                            <span>ğŸ’« èª“ç´„æŠ€:</span>
                            <span><span id="ultimateNormal">0</span> / <span id="ultimateCrit" class="text-yellow-300">0</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç‹€æ…‹ä¿¡æ¯ -->
            <div class="card-gradient rounded-lg p-4 mt-6 text-white text-center">
                <p id="statusInfo" class="text-sm opacity-80">ç³»çµ±å°±ç·’</p>
            </div>
        </div>
    </div>

    <!-- å…§åµŒåŸºç¤æ•¸æ“šå‚™æ´ -->
    <script>
        // å‚™æ´æ•¸æ“šï¼Œç•¶å¤–éƒ¨æ¨¡å¡Šè¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨
        const fallbackData = {
            partners: [
                { id: 'lishen', name: 'é»æ·±' },
                { id: 'qinche', name: 'ç§¦å¾¹' },
                { id: 'shenxinghui', name: 'æ²ˆæ˜Ÿå›' },
                { id: 'xiayizhou', name: 'å¤ä»¥æ™' },
                { id: 'qiyu', name: 'ç¥ç…œ' }
            ],
            professions: {
                'lishen': [
                    { id: 'eternal_prophet', name: 'æ°¸æ†å…ˆçŸ¥' },
                    { id: 'jiuli_commander', name: 'ä¹é»å¸å‘½' }
                ],
                'qinche': [
                    { id: 'endless_raider', name: 'ç„¡ç›¡æ å¥ªè€…' },
                    { id: 'abyss_master', name: 'æ·±æ·µä¸»å®°' }
                ],
                'shenxinghui': [
                    { id: 'light_chaser', name: 'é€å…‰é¨å£«' },
                    { id: 'light_hunter', name: 'å…‰çµ' }
                ],
                'xiayizhou': [
                    { id: 'fleet_officer', name: 'é ç©ºåŸ·è‰¦å®˜' },
                    { id: 'weapon_x02', name: 'çµ‚æ¥µå…µå™¨X-02' }
                ],
                'qiyu': [
                    { id: 'deep_sea_diver', name: 'æ·±æµ·æ½›è¡Œè€…' },
                    { id: 'tidal_god', name: 'æ½®æ±ä¹‹ç¥' }
                ]
            },
            cards: {
                'lishen': [
                    { name: 'æ°¸æ†å°å¡µ', category: 'æ—¥å¡', type: 'defense' },
                    { name: 'æ°¸æ†å¿ƒå½¹', category: 'æ—¥å¡', type: 'defense' },
                    { name: 'æ“é›ªè¦‹ç·£', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'æ“é›ªæœªçœ ', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'å¤±åº', category: 'æœˆå¡', type: 'defense' },
                    { name: 'æŠµæ­¤å¿ƒä¸Š', category: 'æœˆå¡', type: 'attack' }
                ],
                'qinche': [
                    { name: 'æ å¿ƒç›¸æˆ', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'æ å¿ƒå¥ªå‘³', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'æ·±æ·µéœæšˆ', category: 'æ—¥å¡', type: 'life' },
                    { name: 'æ·±æ·µç§˜å°', category: 'æ—¥å¡', type: 'life' }
                ],
                'shenxinghui': [
                    { name: 'é€å…‰ç ´å½±', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'é€å…‰è¿·å¿ƒ', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'æœ«å¤œå¿ƒè²', category: 'æ—¥å¡', type: 'defense' },
                    { name: 'æœ«å¤œé›¨æ„', category: 'æ—¥å¡', type: 'defense' }
                ],
                'xiayizhou': [
                    { name: 'é ç©ºè¿·èˆª', category: 'æ—¥å¡', type: 'defense' },
                    { name: 'é ç©ºæ£ é›¨', category: 'æ—¥å¡', type: 'defense' },
                    { name: 'å¯‚è·¯åŒèµ´', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'å¯‚è·¯ä¸æ­¸', category: 'æ—¥å¡', type: 'attack' }
                ],
                'qiyu': [
                    { name: 'æ·±æµ·æˆè«¾', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'æ·±æµ·æ·¬é‡‘', category: 'æ—¥å¡', type: 'attack' },
                    { name: 'ç¥æ®¿æ—¥è½', category: 'æ—¥å¡', type: 'life' },
                    { name: 'ç¥æ®¿ç§˜ç´„', category: 'æ—¥å¡', type: 'life' }
                ]
            }
        };

        // æŠ€èƒ½å€ç‡
        const skillMultipliers = {
            'eternal_prophet': { basic: 0.8, skill1: 2.2, skill2: 3.8, ultimate: 5.5 },
            'jiuli_commander': { basic: 1.0, skill1: 2.5, skill2: 4.2, ultimate: 6.0 },
            'endless_raider': { basic: 0.9, skill1: 2.3, skill2: 4.0, ultimate: 5.8 },
            'abyss_master': { basic: 0.7, skill1: 2.0, skill2: 3.5, ultimate: 5.2 },
            'light_chaser': { basic: 1.1, skill1: 2.4, skill2: 4.1, ultimate: 6.2 },
            'light_hunter': { basic: 0.8, skill1: 2.1, skill2: 3.7, ultimate: 5.4 },
            'fleet_officer': { basic: 0.9, skill1: 2.2, skill2: 3.9, ultimate: 5.6 },
            'weapon_x02': { basic: 1.0, skill1: 2.6, skill2: 4.3, ultimate: 6.1 },
            'deep_sea_diver': { basic: 0.95, skill1: 2.4, skill2: 4.0, ultimate: 5.9 },
            'tidal_god': { basic: 0.85, skill1: 2.1, skill2: 3.6, ultimate: 5.3 }
        };

        // æ‡‰ç”¨ç‹€æ…‹
        let appData = {
            calc: null,
            usingFallback: false,
            selectedPartner: '',
            selectedProfession: '',
            selectedCards: [],
            bondLevel: 25,
            constellationLevel: 0
        };

        // é™¤éŒ¯è³‡è¨Š
        function updateDebugInfo(message) {
            const debugEl = document.getElementById('debugInfo');
            if (debugEl) {
                const timestamp = new Date().toLocaleTimeString();
                debugEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }

        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            const statusInfo = document.getElementById('statusInfo');
            if (statusEl) statusEl.textContent = message;
            if (statusInfo) statusInfo.textContent = message;
            updateDebugInfo(message);
        }

        function updateProgress(percent) {
            const progressEl = document.getElementById('progressBar');
            if (progressEl) progressEl.style.width = `${percent}%`;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            const retryBtn = document.getElementById('retryBtn');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            if (retryBtn) {
                retryBtn.classList.remove('hidden');
            }
            updateDebugInfo(`âŒ éŒ¯èª¤: ${message}`);
        }

        // æª¢æŸ¥æ¨¡å¡Šè¼‰å…¥ç‹€æ…‹
        function checkModuleStatus() {
            const status = {
                cardDatabase: !!window.cardDatabase,
                baseStatsCalculator: !!window.baseStatsCalculator,
                bonusCalculator: !!window.bonusCalculator,
                teamCalculator: !!window.teamCalculator,
                calc: !!window.calc,
                calcReady: !!(window.calc && window.calc.getAllPartners)
            };

            updateDebugInfo(`æ¨¡å¡Šç‹€æ…‹: ${JSON.stringify(status, null, 2)}`);
            return status;
        }

        // å˜—è©¦åˆå§‹åŒ–è¨ˆç®—å™¨
        function attemptCalculatorInit() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30; // æ¸›å°‘å˜—è©¦æ¬¡æ•¸
                
                const check = () => {
                    attempts++;
                    const status = checkModuleStatus();
                    
                    if (status.calcReady) {
                        updateDebugInfo('âœ… è¨ˆç®—å™¨ç³»çµ±å°±ç·’');
                        appData.calc = window.calc;
                        appData.usingFallback = false;
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        updateDebugInfo('âš ï¸ åˆ‡æ›åˆ°å‚™æ´æ¨¡å¼');
                        appData.usingFallback = true;
                        resolve(false);
                    } else {
                        updateDebugInfo(`æª¢æŸ¥è¨ˆç®—å™¨ç‹€æ…‹ (${attempts}/${maxAttempts})`);
                        setTimeout(check, 200);
                    }
                };
                check();
            });
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        async function initApp() {
            try {
                updateStatus('æª¢æŸ¥æ¨¡å¡Šè¼‰å…¥ç‹€æ…‹...');
                updateProgress(20);
                
                checkModuleStatus();
                
                updateStatus('å˜—è©¦åˆå§‹åŒ–è¨ˆç®—å™¨...');
                updateProgress(40);
                
                const calcReady = await attemptCalculatorInit();
                updateProgress(70);
                
                if (calcReady) {
                    updateStatus('ä½¿ç”¨å®Œæ•´è¨ˆç®—å™¨ç³»çµ±');
                } else {
                    updateStatus('ä½¿ç”¨å‚™æ´æ•¸æ“šç³»çµ±');
                }
                
                updateStatus('åˆå§‹åŒ–ç•Œé¢...');
                initializeUI();
                bindEvents();
                
                updateProgress(100);
                updateStatus('åˆå§‹åŒ–å®Œæˆï¼');
                
                // é¡¯ç¤ºæ‡‰ç”¨
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    updateStatus('ç³»çµ±å°±ç·’ - ' + (appData.usingFallback ? 'å‚™æ´æ¨¡å¼' : 'å®Œæ•´æ¨¡å¼'));
                }, 300);

            } catch (error) {
                updateDebugInfo(`âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                showError(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        }

        // åˆå§‹åŒ–ç•Œé¢
        function initializeUI() {
            const partnerSelect = document.getElementById('partnerSelect');
            
            if (appData.usingFallback) {
                // ä½¿ç”¨å‚™æ´æ•¸æ“š
                fallbackData.partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    option.className = 'text-gray-800';
                    partnerSelect.appendChild(option);
                });
            } else {
                // ä½¿ç”¨å®Œæ•´è¨ˆç®—å™¨
                const partners = appData.calc.getAllPartners() || [];
                partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    option.className = 'text-gray-800';
                    partnerSelect.appendChild(option);
                });
            }
        }

        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('partnerSelect').addEventListener('change', handlePartnerChange);
            document.getElementById('professionSelect').addEventListener('change', handleProfessionChange);
            document.getElementById('bondSlider').addEventListener('input', handleBondChange);
            document.getElementById('constSlider').addEventListener('input', handleConstChange);
            document.getElementById('quickSetup').addEventListener('click', quickSetup);
            document.getElementById('retryBtn').addEventListener('click', () => {
                location.reload();
            });
        }

        // äº‹ä»¶è™•ç†
        function handlePartnerChange(e) {
            appData.selectedPartner = e.target.value;
            updateProfessions();
            updateCards();
        }

        function handleProfessionChange(e) {
            appData.selectedProfession = e.target.value;
            calculate();
        }

        function handleBondChange(e) {
            appData.bondLevel = parseInt(e.target.value);
            document.getElementById('bondValue').textContent = appData.bondLevel;
            calculate();
        }

        function handleConstChange(e) {
            appData.constellationLevel = parseInt(e.target.value);
            document.getElementById('constValue').textContent = appData.constellationLevel;
            calculate();
        }

        // æ›´æ–°è·æ¥­
        function updateProfessions() {
            const professionSelect = document.getElementById('professionSelect');
            professionSelect.innerHTML = '<option value="" class="text-gray-800">é¸æ“‡è·æ¥­</option>';
            
            if (!appData.selectedPartner) return;
            
            let professions = [];
            
            if (appData.usingFallback) {
                professions = fallbackData.professions[appData.selectedPartner] || [];
            } else if (appData.calc) {
                professions = appData.calc.getProfessions(appData.selectedPartner) || [];
            }
            
            professions.forEach(profession => {
                const option = document.createElement('option');
                option.value = profession.id;
                option.textContent = profession.name;
                option.className = 'text-gray-800';
                professionSelect.appendChild(option);
            });
        }

        // æ›´æ–°å¡ç‰‡
        function updateCards() {
            const cardList = document.getElementById('cardList');
            cardList.innerHTML = '';
            appData.selectedCards = [];
            
            if (!appData.selectedPartner) return;
            
            let cards = [];
            
            if (appData.usingFallback) {
                cards = fallbackData.cards[appData.selectedPartner] || [];
            } else if (appData.calc) {
                cards = appData.calc.getCards(appData.selectedPartner) || [];
            }
            
            cards.forEach((card, index) => {
                const cardElement = document.createElement('label');
                cardElement.className = 'flex items-center space-x-2 cursor-pointer hover:bg-white hover:bg-opacity-10 rounded p-2 text-sm';
                cardElement.innerHTML = `
                    <input type="checkbox" class="text-blue-500" data-card-index="${index}">
                    <span class="flex-1">${card.name}</span>
                    <span class="text-xs opacity-60">${card.category}</span>
                `;
                
                cardElement.querySelector('input').addEventListener('change', updateSelectedCards);
                cardList.appendChild(cardElement);
            });
            
            // æ›´æ–°å¡ç‰‡æ•¸æ“šå¼•ç”¨
            appData.cards = cards;
            updateSelectedCount();
        }

        // æ›´æ–°é¸ä¸­å¡ç‰‡
        function updateSelectedCards() {
            appData.selectedCards = [];
            const checkboxes = document.querySelectorAll('#cardList input[type="checkbox"]:checked');
            
            checkboxes.forEach(cb => {
                const cardIndex = parseInt(cb.dataset.cardIndex);
                if (appData.cards[cardIndex]) {
                    appData.selectedCards.push(appData.cards[cardIndex]);
                }
            });
            
            updateSelectedCount();
            calculate();
        }

        // æ›´æ–°é¸ä¸­è¨ˆæ•¸
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = appData.selectedCards.length;
        }

        // å¿«é€Ÿè¨­ç½®
        function quickSetup() {
            document.getElementById('bondSlider').value = 220;
            document.getElementById('constSlider').value = 6;
            appData.bondLevel = 220;
            appData.constellationLevel = 6;
            document.getElementById('bondValue').textContent = '220';
            document.getElementById('constValue').textContent = '6';
            
            // å…¨é¸å¡ç‰‡
            const checkboxes = document.querySelectorAll('#cardList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedCards();
        }

        // è¨ˆç®—å‡½æ•¸
        function calculate() {
            if (!appData.selectedPartner || !appData.selectedProfession || appData.selectedCards.length === 0) {
                resetDisplay();
                return;
            }

            try {
                let teamStats;
                
                if (appData.usingFallback) {
                    // å‚™æ´è¨ˆç®—
                    teamStats = calculateFallback();
                } else if (appData.calc) {
                    // å®Œæ•´è¨ˆç®—
                    const teamConfig = {
                        cardNames: appData.selectedCards.map(card => card.name),
                        levels: new Array(appData.selectedCards.length).fill(80),
                        breakthroughs: new Array(appData.selectedCards.length).fill(1),
                        advancements: new Array(appData.selectedCards.length).fill(3),
                        partnerBondLevel: appData.bondLevel,
                        userConstellationMatch: appData.constellationLevel,
                        userPerfectAlignment: false
                    };
                    teamStats = appData.calc.calculateTeam(teamConfig);
                }
                
                if (teamStats) {
                    updateDisplay(teamStats);
                }
                
            } catch (error) {
                updateDebugInfo(`è¨ˆç®—éŒ¯èª¤: ${error.message}`);
            }
        }

        // å‚™æ´è¨ˆç®—
        function calculateFallback() {
            const cardCount = appData.selectedCards.length;
            const bondBonus = Math.floor(appData.bondLevel / 5) * 10;
            const constBonus = appData.constellationLevel * 50;
            
            const baseAtk = 200 + (cardCount * 150) + bondBonus + constBonus;
            const baseHp = baseAtk * 8;
            const baseDef = baseAtk * 0.6;
            const critRate = 15 + appData.constellationLevel * 2;
            const critDamage = 50 + appData.constellationLevel * 10;
            const weaknessDamage = appData.constellationLevel * 5;
            
            return {
                hp: Math.floor(baseHp),
                atk: Math.floor(baseAtk),
                def: Math.floor(baseDef),
                criticalRate: critRate,
                criticalDamage: critDamage,
                weaknessDamage: weaknessDamage
            };
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay(teamStats) {
            // æ›´æ–°ä¸»è¦å±¬æ€§
            document.getElementById('atkDisplay').textContent = teamStats.atk.toLocaleString();
            
            // è¨ˆç®—æŠ€èƒ½å‚·å®³
            const multipliers = skillMultipliers[appData.selectedProfession] || 
                              { basic: 1.0, skill1: 2.5, skill2: 4.0, ultimate: 6.0 };
            const skillDmg = Math.floor(teamStats.atk * multipliers.ultimate);
            document.getElementById('skillDmgDisplay').textContent = skillDmg.toLocaleString();
            
            // æ›´æ–°è©³ç´°å±¬æ€§
            document.getElementById('hpDetail').textContent = teamStats.hp.toLocaleString();
            document.getElementById('atkDetail').textContent = teamStats.atk.toLocaleString();
            document.getElementById('defDetail').textContent = teamStats.def.toLocaleString();
            document.getElementById('critRateDetail').textContent = teamStats.criticalRate.toFixed(1) + '%';
            document.getElementById('critDmgDetail').textContent = teamStats.criticalDamage.toFixed(1) + '%';
            document.getElementById('weaknessDetail').textContent = teamStats.weaknessDamage.toFixed(1) + '%';
            
            // æ›´æ–°æŠ€èƒ½å‚·å®³
            const baseAtk = teamStats.atk;
            const critDamage = 100 + teamStats.criticalDamage;
            
            ['basic', 'skill1', 'skill2', 'ultimate'].forEach(skill => {
                const multiplier = multipliers[skill];
                const normalDmg = Math.floor(baseAtk * multiplier);
                const critDmg = Math.floor(normalDmg * (critDamage / 100));
                
                document.getElementById(`${skill}Normal`).textContent = normalDmg.toLocaleString();
                document.getElementById(`${skill}Crit`).textContent = critDmg.toLocaleString();
            });
            
            updateStatus(`è¨ˆç®—å®Œæˆ - ${appData.selectedCards.length}å¼µå¡ç‰‡ (${appData.usingFallback ? 'å‚™æ´æ¨¡å¼' : 'å®Œæ•´æ¨¡å¼'})`);
        }

        // é‡ç½®é¡¯ç¤º
        function resetDisplay() {
            ['atkDisplay', 'skillDmgDisplay', 'hpDetail', 'atkDetail', 'defDetail'].forEach(id => {
                document.getElementById(id).textContent = '0';
            });
            ['critRateDetail', 'critDmgDetail', 'weaknessDetail'].forEach(id => {
                document.getElementById(id).textContent = '0%';
            });
            ['basicNormal', 'basicCrit', 'skill1Normal', 'skill1Crit', 
             'skill2Normal', 'skill2Crit', 'ultimateNormal', 'ultimateCrit'].forEach(id => {
                document.getElementById(id).textContent = '0';
            });
        }

        // å¿«é€Ÿæ¸¬è©¦å‡½æ•¸
        function quickTest1() {
            const testResults = document.getElementById('testResults');
            try {
                if (appData.calc && appData.calc.calculateCard) {
                    const result = appData.calc.calculateCard('æ“é›ªè¦‹ç·£', { level: 80, advancement: 3 });
                    testResults.textContent = `âœ… å–®å¡è¨ˆç®—æˆåŠŸ: æ”»æ“Š${result.atk}`;
                } else {
                    testResults.textContent = 'âš ï¸ å®Œæ•´è¨ˆç®—å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨å‚™æ´æ¨¡å¼';
                }
            } catch (error) {
                testResults.textContent = `âŒ å–®å¡è¨ˆç®—å¤±æ•—: ${error.message}`;
            }
        }

        function quickTest2() {
            const testResults = document.getElementById('testResults');
            try {
                if (appData.calc && appData.calc.calculateTeam) {
                    const config = {
                        cardNames: ['æ“é›ªè¦‹ç·£', 'æ°¸æ†å°å¡µ'],
                        levels: [80, 80],
                        breakthroughs: [1, 1],
                        advancements: [3, 3],
                        partnerBondLevel: 25
                    };
                    const result = appData.calc.calculateTeam(config);
                    testResults.textContent = `âœ… éšŠä¼è¨ˆç®—æˆåŠŸ: ç¸½æ”»æ“Š${result.atk}`;
                } else {
                    const result = calculateFallback();
                    testResults.textContent = `âš ï¸ å‚™æ´è¨ˆç®—: æ”»æ“Š${result.atk}`;
                }
            } catch (error) {
                testResults.textContent = `âŒ éšŠä¼è¨ˆç®—å¤±æ•—: ${error.message}`;
            }
        }

        function quickTest3() {
            const testResults = document.getElementById('testResults');
            try {
                const status = checkModuleStatus();
                const moduleCount = Object.values(status).filter(Boolean).length;
                testResults.textContent = `ğŸ“Š æ¨¡å¡Šè¼‰å…¥ç‹€æ…‹: ${moduleCount}/6 å€‹æ¨¡å¡Šå·²è¼‰å…¥`;
            } catch (error) {
                testResults.textContent = `âŒ æ•¸æ“šè¼‰å…¥æª¢æŸ¥å¤±æ•—: ${error.message}`;
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            updateDebugInfo('ğŸš€ é–‹å§‹è¼‰å…¥æˆ°é¬¥è¨ˆç®—å™¨');
            updateStatus('æª¢æŸ¥ç³»çµ±ç’°å¢ƒ...');
            
            // å»¶é²å•Ÿå‹•ï¼Œçµ¦æ¨¡å¡Šè¼‰å…¥æ™‚é–“
            setTimeout(() => {
                initApp().catch(error => {
                    updateDebugInfo(`âŒ å•Ÿå‹•å¤±æ•—: ${error.message}`);
                    showError(`å•Ÿå‹•å¤±æ•—: ${error.message}`);
                });
            }, 1000); // å¢åŠ åˆ°1ç§’å»¶é²
        });

        // è¶…æ™‚è™•ç†
        setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl && !loadingEl.classList.contains('hidden')) {
                updateStatus('è¼‰å…¥è¶…æ™‚ï¼Œåˆ‡æ›åˆ°å‚™æ´æ¨¡å¼');
                // å¼·åˆ¶ä½¿ç”¨å‚™æ´æ¨¡å¼
                appData.usingFallback = true;
                initializeUI();
                bindEvents();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                updateStatus('å‚™æ´æ¨¡å¼å·²å•Ÿå‹•');
            }
        }, 8000); // 8ç§’è¶…æ™‚
    </script>

    <!-- å˜—è©¦è¼‰å…¥å¤–éƒ¨æ¨¡å¡Š -->
    <script>
        // å‹•æ…‹è¼‰å…¥æ¨¡å¡Šï¼Œå¦‚æœå¤±æ•—å‰‡ç¹¼çºŒ
        const modules = [
            'js/data/cardDatabase.js',
            'js/calculators/baseStatsCalculator.js',
            'js/calculators/bonusCalculator.js',
            'js/utils/cardFilters.js',
            'js/utils/partnerProfessionUtils.js',
            'js/systems/coreSystem.js',
            'js/calculators/teamCalculator.js',
            'js/main.js'
        ];

        function loadModulesSafely() {
            modules.forEach((modulePath, index) => {
                const script = document.createElement('script');
                script.src = modulePath;
                script.async = false;
                
                script.onload = () => {
                    updateDebugInfo(`âœ… å·²è¼‰å…¥: ${modulePath}`);
                };
                
                script.onerror = () => {
                    updateDebugInfo(`âŒ è¼‰å…¥å¤±æ•—: ${modulePath}`);
                };
                
                document.head.appendChild(script);
            });
        }

        // é–‹å§‹è¼‰å…¥æ¨¡å¡Š
        loadModulesSafely();
    </script>
</body>
</html>
