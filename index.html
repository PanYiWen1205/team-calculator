<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ°é¬¥éšŠä¼çµ„å»ºè¨ˆç®—æ©Ÿ - æ¨¡å¡ŠåŒ–ç‰ˆæœ¬ v2.0</title>
    
    <!-- React å’Œç›¸é—œç¨‹å¼åº« -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS æ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è‡ªå®šç¾©æ¨£å¼ -->
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f8fafc;
        }
        
        /* å„ªåŒ–æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 1.2rem;
            color: #64748b;
        }
        
        /* å¡ç‰‡hoveræ•ˆæœ */
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* æ•¸å€¼è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆèª¿æ•´ */
        @media (max-width: 768px) {
            .grid-cols-4 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            
            .xl\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }
        
        /* æ˜Ÿè­œè‰²å½© */
        .constellation-blue { color: #3b82f6; }
        .constellation-green { color: #10b981; }
        .constellation-purple { color: #8b5cf6; }
        .constellation-yellow { color: #f59e0b; }
        .constellation-red { color: #ef4444; }
        .constellation-pink { color: #ec4899; }
        
        /* æ¨¡å¡Šè¼‰å…¥ç‹€æ…‹ */
        .module-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .module-loaded {
            background-color: #10b981;
        }
        
        .module-error {
            background-color: #ef4444;
        }
        
        .module-loading {
            background-color: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* é€²åº¦æ¢ */
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥æç¤º -->
    <div id="loading" class="loading">
        <div class="text-center max-w-md mx-auto p-6">
            <div class="flex items-center justify-center mb-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                <span class="text-lg font-medium">è¼‰å…¥æˆ°é¬¥éšŠä¼çµ„å»ºè¨ˆç®—æ©Ÿ v2.0...</span>
            </div>
            
            <!-- é€²åº¦æ¢ -->
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            
            <div id="loadingStatus" class="text-sm text-gray-600">
                <div id="currentModule" class="mb-2 font-medium">åˆå§‹åŒ–ä¸­...</div>
                <div id="moduleStatus" class="space-y-1 text-left"></div>
            </div>
        </div>
    </div>
    
    <!-- ç°¡å–®çš„åŠŸèƒ½æ¸¬è©¦ç•Œé¢ -->
    <div id="testInterface" style="display: none;" class="min-h-screen bg-gray-50 py-8">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                    ğŸ† æˆ°é¬¥éšŠä¼çµ„å»ºè¨ˆç®—æ©Ÿ v2.0
                </h1>
                <p class="text-center text-gray-600 mb-8">
                    æ¨¡å¡ŠåŒ–æ¶æ§‹ | èŠ¯æ ¸ç³»çµ± | è·æ¥­ç³»çµ±
                </p>
                
                <!-- åŠŸèƒ½æ¸¬è©¦æŒ‰éˆ• -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button onclick="testBasicCalculation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        åŸºç¤è¨ˆç®—æ¸¬è©¦
                    </button>
                    <button onclick="testProfessionSystem()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        è·æ¥­ç³»çµ±æ¸¬è©¦
                    </button>
                    <button onclick="testCoreSystem()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        èŠ¯æ ¸ç³»çµ±æ¸¬è©¦
                    </button>
                    <button onclick="showHelp()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        é¡¯ç¤ºAPI
                    </button>
                </div>
                
                <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
                <div id="testResults" class="bg-gray-50 rounded-lg p-4 min-h-32">
                    <p class="text-gray-500 text-center">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ¸¬è©¦åŠŸèƒ½</p>
                </div>
                
                <!-- ç‹€æ…‹ä¿¡æ¯ -->
                <div class="mt-6 text-sm text-gray-500 text-center">
                    <p>æ¨¡å¡Šè¼‰å…¥å®Œæˆ | ç‰ˆæœ¬: v2.0-modular | ä½¿ç”¨ <code>calc.help()</code> æŸ¥çœ‹å®Œæ•´API</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- React æ‡‰ç”¨æœƒæ›è¼‰åˆ°é€™è£¡ -->
    <div id="root" style="display: none;"></div>
    
    <!-- æ¨¡å¡Šè¼‰å…¥ç®¡ç†å™¨ -->
    <script>
        // æ¨¡å¡Šè¼‰å…¥ç‹€æ…‹ç®¡ç†
        class ModuleLoader {
            constructor() {
                this.modules = [
                    { name: 'æ•¸æ“šåº«', file: 'js/data/cardDatabase.js', loaded: false, required: true },
                    { name: 'åŸºç¤è¨ˆç®—', file: 'js/calculators/baseStatsCalculator.js', loaded: false, required: true },
                    { name: 'åŠ æˆè¨ˆç®—', file: 'js/calculators/bonusCalculator.js', loaded: false, required: true },
                    { name: 'éšŠä¼è¨ˆç®—', file: 'js/calculators/teamCalculator.js', loaded: false, required: true },
                    { name: 'èŠ¯æ ¸ç³»çµ±', file: 'js/systems/coreSystem.js', loaded: false, required: true },
                    { name: 'å¡ç‰‡å·¥å…·', file: 'js/utils/cardFilters.js', loaded: false, required: true },
                    { name: 'è·æ¥­å·¥å…·', file: 'js/utils/partnerProfessionUtils.js', loaded: false, required: true },
                    { name: 'ä¸»ç¨‹åº', file: 'js/main.js', loaded: false, required: true },
                    { name: 'Reactæ‡‰ç”¨', file: 'app.js', loaded: false, required: false }
                ];
                this.loadedCount = 0;
                this.totalCount = this.modules.filter(m => m.required).length;
                this.initStatusDisplay();
            }
            
            initStatusDisplay() {
                const statusDiv = document.getElementById('moduleStatus');
                this.modules.forEach((module, index) => {
                    if (module.required) {
                        const div = document.createElement('div');
                        div.id = `module-${index}`;
                        div.innerHTML = `<span class="module-status module-loading"></span>${module.name}`;
                        statusDiv.appendChild(div);
                    }
                });
                this.updateProgress();
            }
            
            updateModuleStatus(index, status) {
                const moduleDiv = document.getElementById(`module-${index}`);
                if (moduleDiv) {
                    const statusSpan = moduleDiv.querySelector('.module-status');
                    statusSpan.className = `module-status module-${status}`;
                }
                
                if (status === 'loaded') {
                    this.modules[index].loaded = true;
                    if (this.modules[index].required) {
                        this.loadedCount++;
                    }
                }
                
                this.updateProgress();
                this.checkAllLoaded();
            }
            
            updateProgress() {
                const progress = (this.loadedCount / this.totalCount) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('currentModule').textContent = 
                    `è¼‰å…¥é€²åº¦: ${this.loadedCount}/${this.totalCount} (${Math.round(progress)}%)`;
            }
            
            checkAllLoaded() {
                if (this.loadedCount === this.totalCount) {
                    this.onAllLoaded();
                }
            }
            
            onAllLoaded() {
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ React æ‡‰ç”¨
                    if (this.modules[8].loaded) {
                        document.getElementById('root').style.display = 'block';
                    } else {
                        document.getElementById('testInterface').style.display = 'block';
                    }
                    
                    console.log('ğŸ‰ æ‰€æœ‰æ ¸å¿ƒæ¨¡å¡Šè¼‰å…¥å®Œæˆï¼');
                    console.log('ğŸ’¡ ä½¿ç”¨ calc.help() æŸ¥çœ‹å¯ç”¨API');
                    console.log('ğŸ“Š ä½¿ç”¨ calc.stats() æŸ¥çœ‹çµ±è¨ˆä¿¡æ¯');
                }, 500);
            }
            
            onError(index, error) {
                this.updateModuleStatus(index, 'error');
                console.error(`æ¨¡å¡Šè¼‰å…¥å¤±æ•—: ${this.modules[index].name}`, error);
                
                // å¦‚æœæ˜¯å¿…éœ€æ¨¡å¡Šå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤
                if (this.modules[index].required) {
                    setTimeout(() => {
                        document.getElementById('loading').innerHTML = 
                            `<div class="text-center">
                                <div class="text-red-600 mb-4">âŒ é—œéµæ¨¡å¡Šè¼‰å…¥å¤±æ•—</div>
                                <div class="text-sm text-gray-600">
                                    <p>å¤±æ•—çš„æ¨¡å¡Š: <strong>${this.modules[index].name}</strong></p>
                                    <p>æ–‡ä»¶è·¯å¾‘: <code>${this.modules[index].file}</code></p>
                                    <p class="mt-2">è«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”è·¯å¾‘æ­£ç¢º</p>
                                    <button onclick="location.reload()" 
                                            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        é‡æ–°è¼‰å…¥
                                    </button>
                                </div>
                            </div>`;
                    }, 1000);
                }
            }
        }
        
        // å‰µå»ºæ¨¡å¡Šè¼‰å…¥å™¨å¯¦ä¾‹
        const moduleLoader = new ModuleLoader();
        
        // å‹•æ…‹è¼‰å…¥è…³æœ¬çš„å‡½æ•¸
        function loadScript(src, index) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    moduleLoader.updateModuleStatus(index, 'loaded');
                    resolve();
                };
                script.onerror = (error) => {
                    moduleLoader.onError(index, error);
                    // éå¿…éœ€æ¨¡å¡Šå¤±æ•—æ™‚ä¸reject
                    if (!moduleLoader.modules[index].required) {
                        resolve();
                    } else {
                        reject(error);
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // æŒ‰é †åºè¼‰å…¥æ¨¡å¡Š
        async function loadModules() {
            // æª¢æŸ¥ React æ˜¯å¦è¼‰å…¥
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                document.getElementById('loading').innerHTML = 
                    '<div class="text-red-600">éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ React åº«ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥ã€‚</div>';
                return;
            }
            
            try {
                // è¼‰å…¥æ ¸å¿ƒæ¨¡å¡Šï¼ˆæŒ‰ä¾è³´é †åºï¼‰
                for (let i = 0; i < moduleLoader.modules.length - 1; i++) {
                    await loadScript(moduleLoader.modules[i].file, i);
                }
                
                // æœ€å¾Œè¼‰å…¥ React æ‡‰ç”¨ï¼ˆå¯é¸ï¼‰
                const lastIndex = moduleLoader.modules.length - 1;
                const script = document.createElement('script');
                script.type = 'text/babel';
                script.src = moduleLoader.modules[lastIndex].file;
                script.onload = () => {
                    moduleLoader.updateModuleStatus(lastIndex, 'loaded');
                };
                script.onerror = (error) => {
                    moduleLoader.onError(lastIndex, error);
                };
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('æ¨¡å¡Šè¼‰å…¥éç¨‹ä¸­å‡ºç¾éŒ¯èª¤:', error);
            }
        }
        
        // æ¸¬è©¦å‡½æ•¸
        function testBasicCalculation() {
            const results = document.getElementById('testResults');
            try {
                const result = calc.calculateCard('æ“é›ªè¦‹ç·£', { level: 80, advancement: 3 });
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2">âœ… åŸºç¤è¨ˆç®—æ¸¬è©¦æˆåŠŸ</h3>
                    <pre class="bg-white p-3 rounded border text-sm overflow-auto">${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-red-600">âŒ åŸºç¤è¨ˆç®—æ¸¬è©¦å¤±æ•—</h3>
                    <p class="text-red-600">${error.message}</p>
                `;
            }
        }
        
        function testProfessionSystem() {
            const results = document.getElementById('testResults');
            try {
                const professions = calc.getProfessions('lishen');
                const bondBonus = calc.calculateBond(25);
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2">âœ… è·æ¥­ç³»çµ±æ¸¬è©¦æˆåŠŸ</h3>
                    <div class="bg-white p-3 rounded border text-sm">
                        <p><strong>é»æ·±çš„è·æ¥­:</strong> ${professions.map(p => p.name).join(', ')}</p>
                        <p><strong>25ç´šç‰½çµ†åŠ æˆ:</strong> HP+${bondBonus.hp}, ATK+${bondBonus.atk}, DEF+${bondBonus.def}</p>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-red-600">âŒ è·æ¥­ç³»çµ±æ¸¬è©¦å¤±æ•—</h3>
                    <p class="text-red-600">${error.message}</p>
                `;
            }
        }
        
        function testCoreSystem() {
            const results = document.getElementById('testResults');
            try {
                const coreTypes = calc.getCores('æ—¥å¡');
                const alphaTemplate = calc.coreTemplate('alpha');
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2">âœ… èŠ¯æ ¸ç³»çµ±æ¸¬è©¦æˆåŠŸ</h3>
                    <div class="bg-white p-3 rounded border text-sm">
                        <p><strong>æ—¥å¡å¯ç”¨èŠ¯æ ¸:</strong> ${Object.keys(coreTypes).join(', ')}</p>
                        <p><strong>Î±èŠ¯æ ¸æ¨¡æ¿:</strong></p>
                        <pre class="mt-2 text-xs">${JSON.stringify(alphaTemplate, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-red-600">âŒ èŠ¯æ ¸ç³»çµ±æ¸¬è©¦å¤±æ•—</h3>
                    <p class="text-red-600">${error.message}</p>
                `;
            }
        }
        
        function showHelp() {
            const results = document.getElementById('testResults');
            try {
                const methods = calc.help();
                let html = '<h3 class="font-bold text-lg mb-2">ğŸ“š å¯ç”¨ API æ–¹æ³•</h3><div class="bg-white p-3 rounded border text-sm">';
                Object.entries(methods).forEach(([category, methodList]) => {
                    html += `<h4 class="font-semibold mt-3 mb-1">${category}:</h4><ul class="list-disc list-inside ml-2">`;
                    methodList.forEach(method => {
                        html += `<li><code class="text-xs bg-gray-100 px-1 rounded">${method}</code></li>`;
                    });
                    html += '</ul>';
                });
                html += '</div>';
                results.innerHTML = html;
            } catch (error) {
                results.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-red-600">âŒ å¹«åŠ©ä¿¡æ¯è¼‰å…¥å¤±æ•—</h3>
                    <p class="text-red-600">${error.message}</p>
                `;
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œé–‹å§‹è¼‰å…¥æ¨¡å¡Š
        document.addEventListener('DOMContentLoaded', loadModules);
        
        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', function(e) {
            console.error('æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:', e.error);
            document.getElementById('loading').innerHTML = 
                `<div class="text-center">
                    <div class="text-red-600 mb-4">âŒ æ‡‰ç”¨ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤</div>
                    <div class="text-sm text-gray-600">
                        <p>${e.error.message}</p>
                        <p class="mt-2">è«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–è©³ç´°éŒ¯èª¤ä¿¡æ¯</p>
                        <button onclick="location.reload()" 
                                class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                </div>`;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('root').style.display = 'none';
            document.getElementById('testInterface').style.display = 'none';
        });
        
        // è¼‰å…¥è¶…æ™‚æª¢æŸ¥
        setTimeout(() => {
            if (document.getElementById('loading').style.display !== 'none') {
                const loadingDiv = document.getElementById('loading');
                const currentContent = loadingDiv.innerHTML;
                if (!currentContent.includes('éŒ¯èª¤') && !currentContent.includes('å¤±æ•—')) {
                    loadingDiv.innerHTML = 
                        `<div class="text-center">
                            <div class="text-orange-600 mb-4">âš ï¸ è¼‰å…¥è¶…æ™‚</div>
                            <div class="text-sm text-gray-600">
                                <p>æŸäº›æ¨¡å¡Šè¼‰å…¥æ™‚é–“éé•·ï¼Œè«‹æª¢æŸ¥ï¼š</p>
                                <ul class="list-disc list-inside mt-2 text-left">
                                    <li>ç¶²çµ¡é€£æ¥æ˜¯å¦æ­£å¸¸</li>
                                    <li>æ‰€æœ‰ JS æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
                                    <li>æ–‡ä»¶è·¯å¾‘æ˜¯å¦æ­£ç¢º</li>
                                </ul>
                                <button onclick="location.reload()" 
                                        class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    é‡æ–°è¼‰å…¥
                                </button>
                            </div>
                        </div>`;
                }
            }
        }, 15000);
        
        // æ¨¡å¡Šè¼‰å…¥å®Œæˆå¾Œçš„èª¿è©¦ä¿¡æ¯
        window.addEventListener('load', function() {
            if (window.calc) {
                console.log('ğŸš€ æˆ°é¬¥éšŠä¼çµ„å»ºè¨ˆç®—æ©Ÿ v2.0 å·²å°±ç·’');
                console.log('ğŸ’¡ ä½¿ç”¨ calc.help() æŸ¥çœ‹å¯ç”¨API');
                console.log('ğŸ“Š ä½¿ç”¨ calc.stats() æŸ¥çœ‹çµ±è¨ˆä¿¡æ¯');
                console.log('ğŸ”§ èª¿è©¦ä¿¡æ¯å¯åœ¨æ§åˆ¶å°æŸ¥çœ‹');
                
                // æ·»åŠ å…¨åŸŸèª¿è©¦è®Šæ•¸
                window.debugInfo = {
                    version: '2.0.0-modular',
                    loadTime: Date.now(),
                    modules: moduleLoader.modules.map(m => ({
                        name: m.name,
                        loaded: m.loaded,
                        required: m.required
                    }))
                };
            }
        });
    </script>
</body>
</html>
